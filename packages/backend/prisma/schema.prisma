generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────

enum UserRole {
  COMMUNITY
  BUSINESS_OWNER
  MODERATOR
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  PENDING
  DELETED
}

enum CategoryType {
  BUSINESS
  EVENT
  DEAL
  NOTICE
  GROUP
}

enum ActorRole {
  USER
  BUSINESS_OWNER
  MODERATOR
  ADMIN
  SYSTEM
}

// ─── Models ──────────────────────────────────────────────

/// Spec A.2 - Platform user accounts
/// Note: `status` defaults to PENDING (not ACTIVE) intentionally -- new users must
/// verify their email before becoming active. This is a security-driven deviation
/// from the spec's enumeration order. See Spec Section 4.5 (email verification).
model User {
  id                      String     @id @default(uuid())
  email                   String     @unique
  passwordHash            String     @map("password_hash")
  displayName             String     @map("display_name")
  profilePhoto            String?    @map("profile_photo")
  languagePreference      String     @default("en") @map("language_preference")
  suburb                  String?
  bio                     String?    @db.VarChar(500)
  interests               String[]
  notificationPreferences Json?      @map("notification_preferences")
  role                    UserRole   @default(COMMUNITY)
  status                  UserStatus @default(PENDING)
  emailVerified           Boolean    @default(false) @map("email_verified")
  pendingEmail            String?    @map("pending_email")
  deletionRequestedAt     DateTime?  @map("deletion_requested_at")
  createdAt               DateTime   @default(now()) @map("created_at")
  updatedAt               DateTime   @updatedAt @map("updated_at")
  lastLogin               DateTime?  @map("last_login")

  sessions  UserSession[]
  auditLogs AuditLog[]

  @@map("users")
}

/// Spec A.14 - Hierarchical taxonomy for businesses, events, deals, etc.
model Category {
  id           String       @id @default(uuid())
  type         CategoryType
  name         Json         // Multilingual: {"en": "Restaurant", "ar": "مطعم"}
  slug         String
  icon         String       @default("default")
  parentId     String?      @map("parent_id")
  parent       Category?    @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children     Category[]   @relation("CategoryHierarchy")
  displayOrder Int          @default(0) @map("display_order")
  active       Boolean      @default(true)
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  @@unique([type, slug])
  @@index([type, active])
  @@map("categories")
}

/// Spec A.17 - Active user sessions for security audit
model UserSession {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash    String   @unique @map("token_hash")
  deviceInfo   Json     @map("device_info") // {user_agent, device_type, os, browser}
  ipAddress    String   @map("ip_address")
  location     String?  // city/country from IP geolocation
  isCurrent    Boolean  @default(false) @map("is_current")
  lastActiveAt DateTime @map("last_active_at")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([expiresAt])
  @@map("user_sessions")
}

/// Spec A.18 - Immutable audit trail (7-year retention)
model AuditLog {
  id            String    @id @default(uuid())
  actorId       String?   @map("actor_id")
  actor         User?     @relation(fields: [actorId], references: [id], onDelete: SetNull)
  actorRole     ActorRole @map("actor_role")
  action        String    // e.g. "review.delete", "user.suspend"
  targetType    String    @map("target_type") // e.g. "Review", "User"
  targetId      String    @map("target_id")
  previousValue Json?     @map("previous_value")
  newValue      Json?     @map("new_value")
  reason        String?
  ipAddress     String    @map("ip_address")
  userAgent     String    @map("user_agent")
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([actorId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("audit_logs")
}

/// Spec A.19 - Multilingual email templates (runtime-editable)
model EmailTemplate {
  id          String   @id @default(uuid())
  templateKey String   @unique @map("template_key") // e.g. "welcome", "password_reset"
  name        String
  description String
  subject     Json     // Multilingual: {"en": "Welcome!", "ar": "..."}
  bodyHtml    Json     @map("body_html") // Multilingual HTML
  bodyText    Json     @map("body_text") // Multilingual plain text
  variables   String[] // ["userName", "verificationLink"]
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("email_templates")
}

/// Spec A.24 - Runtime-editable platform settings
model SystemSetting {
  key         String   @id
  value       Json
  description String
  updatedBy   String?  @map("updated_by")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}
