# QA Review #3 - Phase 1 (Subsections 1.1 + 1.2)

**Date:** 2 February 2026
**Reviewer:** Automated QA
**Scope:** Post-fix re-review after all Review #2 remediation
**Previous Reviews:**
- Review #1: 32 issues (1C, 5H, 14M, 12L) -- all remediated
- Review #2: 25 issues (0C, 1H, 8M, 16L) -- all remediated

---

## Executive Summary

All 25 issues from Review #2 have been verified as properly resolved. The codebase is in excellent shape after three rounds of review and two rounds of fixes. This review found **0 Critical, 0 High, 3 Medium, and 7 Low** new issues -- a significant improvement from the previous 25.

The most actionable finding is the `.gitignore` wildcard `.env.*` inadvertently blocking `docker/.env.docker.example` from being committed, which should be fixed before the next commit.

**This review found: 0 CRITICAL, 0 HIGH, 3 MEDIUM, 7 LOW issues.**

| Severity | Count | Breakdown |
|----------|-------|-----------|
| CRITICAL | 0 | -- |
| HIGH | 0 | -- |
| MEDIUM | 3 | .gitignore blocks docker env template, missing ELASTIC_PASSWORD in template, test fixtures in prod barrel |
| LOW | 7 | Redundant gitignore line, validate.test.ts missing afterEach, location-specific test string, defaultKeywords allows empty, featureGate return type, unused globals:true, BCP 47 regex subset |

---

## Review #2 Remediation Status (25/25 Verified)

### HIGH (1/1 Fixed)

| ID | Issue | Status |
|----|-------|--------|
| H1 | Zero test coverage for prototype pollution | **FIXED** -- Three tests added in `deep-merge.test.ts:71-96` for `__proto__`, `constructor`, `prototype`. Uses `JSON.parse` for `__proto__` (correct approach). |

### MEDIUM (8/8 Fixed)

| ID | Issue | Status |
|----|-------|--------|
| M1 | ES healthcheck fails with xpack security | **FIXED** -- Staging/prod overlays override healthcheck with `curl -f -u elastic:${ELASTIC_PASSWORD}`. `ELASTIC_PASSWORD` required via `${...:?}` syntax. |
| M2 | .gitignore missing .env.* coverage | **FIXED** -- Now `.env.*` with `!.env.example` negation. See new M1 for side effect. |
| M3 | SESSION_SECRET min 32, spec requires 64 | **FIXED** -- `env-validate.ts:27` now `min(64)`. Test updated to match. |
| M4 | Hardcoded meta tags | **FIXED** -- `TODO(Phase 1.4)` comment added in `index.html:6`. |
| M5 | Silent failure when #root missing | **FIXED** -- `main.tsx:9-11` throws explicit error. |
| M6 | allEnabled fixture duplication | **FIXED** -- `allEnabledFeatures` in `shared/__tests__/fixtures.ts`. Used by all 3 consumer test files. |
| M7 | validConfig fixture duplication | **FIXED** -- `createValidPlatformConfig()` factory in `shared/__tests__/fixtures.ts`. Used by both platform-loader tests. |
| M8 | No AbortController timeout test | **FIXED** -- `frontend/platform-loader.test.ts:80-94` mocks fetch with abort listener, tests 50ms timeout. |

### LOW (16/16 Fixed)

| ID | Issue | Status |
|----|-------|--------|
| L1 | Zod error formatting duplication | **FIXED** -- `formatZodErrors()` in `shared/config/format-zod-errors.ts`, used by all 3 consumers. |
| L2 | isPlainObject too permissive | **FIXED** -- Now checks `Object.getPrototypeOf` against `Object.prototype` or `null`. |
| L3 | Locale accepts any 2+ char string | **FIXED** -- Regex `/^[a-z]{2}(-[A-Z]{2})?$/` on `platform-schema.ts:67`. |
| L4 | Language code no BCP 47 check | **FIXED** -- Same regex on `platform-schema.ts:23` and `:129`. |
| L5 | Timezone refine untested | **FIXED** -- Test with `"Invalid/Timezone"` in `platform-schema.test.ts:71-83`. |
| L6 | no-explicit-any is warn | **FIXED** -- Now `'error'` in `eslint.config.js:30`. |
| L7 | CI lacks concurrency group | **FIXED** -- `concurrency: { group: ..., cancel-in-progress: true }` in `ci.yml:9-11`. |
| L8 | Mailpit not on backend network | **FIXED** -- `networks: [backend]` in `docker-compose.dev.yml:21-22`. |
| L9 | Mailpit uses unpinned latest | **FIXED** -- Pinned to `axllent/mailpit:v1.21`. |
| L10 | PROGRESS.md stale header | **FIXED** -- Updated to "Phase 1 -- Foundation & Core Infrastructure (In Progress)". |
| L11 | PROGRESS.md stale date | **FIXED** -- Updated to "2 February 2026". |
| L12 | PROGRESS.md outdated tech stack note | **FIXED** -- Strikethrough with confirmation. |
| L13 | vi.unstubAllEnvs() in test body | **FIXED** -- Now in `afterEach` at `backend/platform-loader.test.ts:30`. |
| L14 | vi.unstubAllGlobals() in test body | **FIXED** -- Now in `afterEach` at `frontend/platform-loader.test.ts:19` and `:103`. |
| L15 | Location-specific test emails | **FIXED** -- Uses `example.com` in `platform-schema.test.ts:89-91`. |
| L16 | Uppercase Docs/ path in study file | **FIXED** -- Changed to `docs/` in `md/study/phase-1.md`. |

---

## New Issues Found

### MEDIUM (3 issues)

#### M1: `.gitignore` wildcard `.env.*` blocks `docker/.env.docker.example`

- **File:** `.gitignore:12-13`
- **Severity:** MEDIUM
- **Detail:** The `.env.*` pattern on line 12 matches files in all directories. This causes `docker/.env.docker.example` to be ignored because its filename `.env.docker.example` matches `.env.*`. The negation `!.env.example` on line 13 only un-ignores files named exactly `.env.example`, not `.env.docker.example`. Without a fix, the Docker env template will not be committed, leaving developers without Docker setup instructions after cloning.
- **Fix:** Add a specific negation:
  ```gitignore
  .env
  .env.*
  !.env.example
  !docker/.env.docker.example
  ```

#### M2: `docker/.env.docker.example` missing `ELASTIC_PASSWORD`

- **File:** `docker/.env.docker.example` (end of file)
- **Severity:** MEDIUM
- **Detail:** The staging and prod Docker Compose overlays require `ELASTIC_PASSWORD` via `${ELASTIC_PASSWORD:?ELASTIC_PASSWORD must be set}`. The template file only contains `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`, and `REDIS_PASSWORD`. A developer following the template for staging/prod deployment will get a hard error.
- **Fix:** Add `ELASTIC_PASSWORD=CHANGEME` with a comment noting it's required for staging/prod.

#### M3: Test fixtures exported from production barrel (`shared/index.ts`)

- **File:** `packages/shared/src/index.ts:28`
- **Severity:** MEDIUM
- **Detail:** `allEnabledFeatures` and `createValidPlatformConfig` are exported from the main barrel file alongside production exports. Test helper code ships in the production bundle and is importable by production consumers. While tree-shaking may eliminate these, the API surface is semantically confusing.
- **Fix:** Create a separate export path `@community-hub/shared/testing` using `package.json` `exports` map. Remove test fixture exports from `src/index.ts`.

---

### LOW (7 issues)

#### L1: Redundant `docker/.env.docker` line in `.gitignore`

- **File:** `.gitignore:14`
- **Severity:** LOW
- **Detail:** Already covered by the `.env.*` wildcard on line 12. Removing this line reduces clutter.

#### L2: `validate.test.ts` missing `afterEach` for consistency

- **File:** `packages/backend/src/__tests__/validate.test.ts`
- **Severity:** LOW
- **Detail:** Uses `vi.mock()` at module level and `vi.clearAllMocks()` in `beforeEach`, but no `afterEach` block. While functional, this is inconsistent with the cleanup discipline in other test files. Adding `afterEach(() => { vi.restoreAllMocks(); })` would be consistent.

#### L3: Location-specific string `'guildford'` in deep-merge test

- **File:** `packages/shared/src/__tests__/deep-merge.test.ts:46,50,54`
- **Severity:** LOW
- **Detail:** Uses `'guildford'` and `'guildford-dev'` as test platform IDs. Functionally harmless but inconsistent with the location-agnostic convention used in `fixtures.ts` (`'test'`, `'test-dev'`).
- **Fix:** Replace with `'test'` and `'test-dev'`.

#### L4: `defaultKeywords` schema allows empty strings

- **File:** `packages/shared/src/config/platform-schema.ts:138`
- **Severity:** LOW
- **Detail:** `z.array(z.string())` accepts empty strings, while every other string field uses `.min(1)`. The `secondaryHashtags` array on line 100 uses `z.string().min(1)`.
- **Fix:** Change to `z.array(z.string().min(1))`.

#### L5: `featureGate` missing explicit return type

- **File:** `packages/backend/src\middleware/feature-gate.ts:13-16`
- **Severity:** LOW
- **Detail:** The outer factory function relies on type inference for its return type. An explicit `(req: Request, res: Response, next: NextFunction) => void` return type would make the API contract clearer.

#### L6: `globals: true` in vitest configs is unused

- **File:** All three `vitest.config.ts` files
- **Severity:** LOW
- **Detail:** All 12 test files explicitly import from `'vitest'`. The `globals: true` setting is unnecessary and could allow future tests to accidentally skip imports.
- **Fix:** Remove `globals: true` from all three configs.

#### L7: BCP 47 regex is a subset; does not cover script subtags

- **File:** `packages/shared/src/config/platform-schema.ts:23`
- **Severity:** LOW
- **Detail:** `/^[a-z]{2}(-[A-Z]{2})?$/` matches `en`, `zh-CN` but would reject `zh-Hant` (script subtag). All current 10 languages pass. The error message says "BCP 47" but the regex is a simplified subset.
- **Fix:** Document in schema that only `ll` and `ll-RR` forms are supported. Extend later if needed.

---

## Code Quality Metrics

| Metric | Value | Assessment |
|--------|-------|------------|
| Total source files | 16 | Well within limits |
| Total test files | 12 + 1 fixture | Comprehensive |
| Tests passing | 72/72 | All green (up from 67) |
| Files > 1000 lines | 0 | No monolithic files |
| Largest source file | 182 lines (platform-schema.ts) | Acceptable |
| `any` type usage | 0 | Excellent |
| `@ts-ignore` usage | 0 | Excellent |
| `@ts-expect-error` usage | 0 | Excellent |
| `console.log` in source | 0 | Uses Pino logger |
| `process.exit` in source | 0 | Throws instead |
| ESLint warnings/errors | 0 | Clean |
| `no-explicit-any` rule | `error` | Enforced |

### TypeScript Strictness

| Setting | Value |
|---------|-------|
| `strict` | true |
| `noUnusedLocals` | true |
| `noUnusedParameters` | true |
| `noFallthroughCasesInSwitch` | true |
| `noUncheckedIndexedAccess` | true |
| `isolatedModules` | true |

### Docker Images

| Image | Version | Pinned |
|-------|---------|--------|
| postgres | 16-alpine | Yes |
| redis | 7-alpine | Yes |
| elasticsearch | 8.17.0 | Yes |
| mailpit | v1.21 | Yes |

---

## Specification Compliance

| Area | Status | Notes |
|------|--------|-------|
| Spec Section 2.3 (env vars) | PASS | All 32 variables present and validated |
| Spec Section 2.4 (platform.json schema) | PASS | All 11 sections, all nested fields |
| Spec Section 2.5 (feature flags) | PASS | All 16 flags with gating |
| Spec Section 2.8 (config access pattern) | PASS | Load once, cache, merge overrides |
| Spec Section 2.9 (validation rules) | PASS | All required validations + BCP 47, locale regex |
| Spec Section 2.10 (security) | PASS | No secrets in source, prototype pollution protection |
| Spec Section 2.7 (deployment checklist) | PASS | Superset of spec requirements |
| Location-agnostic architecture | PASS | No hardcoded location data in production source |
| SESSION_SECRET minimum | PASS | 64 chars (matches spec) |

---

## Security Assessment

| Check | Status | Detail |
|-------|--------|--------|
| No hardcoded secrets | PASS | All passwords use `${VAR:?}` in Docker, no secrets in source |
| Prototype pollution protection | PASS | 3 DANGEROUS_KEYS blocked, 3 tests verify |
| Input validation | PASS | Zod schemas for all config, regex for locales/countries |
| `isPlainObject` defensive check | PASS | Verifies prototype chain |
| SESSION_SECRET strength | PASS | 64-char minimum enforced |
| ENCRYPTION_KEY strength | PASS | 44-char minimum (base64 AES-256) |
| DATABASE_URL format check | PASS | Must start with `postgresql://` |
| ES security per environment | PASS | Disabled only in dev overlay |
| Redis authentication | PASS | Required password via `--requirepass` |
| .env file protection | PASS | `.env.*` gitignored with `.env.example` negation |

---

## Plan Completion Status

| Subsection | Tasks | Complete | Status |
|------------|-------|----------|--------|
| 1.1 Development Environment | 10 | 10 | 100% |
| 1.2 Configuration Architecture | 6 | 6 | 100% |
| 1.3 Backend Infrastructure | 9 | 0 | Not Started |
| 1.4 Frontend Infrastructure | 7 | 0 | Not Started |
| 1.5 Security Foundation | 11 | 0 | Not Started |
| 1.6 Email Service | 5 | 0 | Not Started |
| 1.7 Maps Integration | 5 | 0 | Not Started |
| 1.8 i18n Foundation | 6 | 0 | Not Started |
| **Total Phase 1** | **59** | **16** | **27%** |

---

## Issue Trend Across Reviews

| Review | CRITICAL | HIGH | MEDIUM | LOW | Total |
|--------|----------|------|--------|-----|-------|
| Review #1 | 1 | 5 | 14 | 12 | 32 |
| Review #2 | 0 | 1 | 8 | 16 | 25 |
| **Review #3** | **0** | **0** | **3** | **7** | **10** |

All issues from Reviews #1 and #2 have been verified as properly resolved.

---

## Recommendations

### Before Next Commit

1. **Fix M1** -- Add `!docker/.env.docker.example` to `.gitignore` (prevents template from being excluded)
2. **Fix M2** -- Add `ELASTIC_PASSWORD=CHANGEME` to `docker/.env.docker.example`
3. **Fix L3** -- Replace `'guildford'` with `'test'` in deep-merge test

### During Phase 1.3-1.4

4. **Fix M3** -- Create `@community-hub/shared/testing` export path for test fixtures
5. **Fix L1** -- Remove redundant `docker/.env.docker` gitignore line
6. **Fix L4** -- Add `.min(1)` to `defaultKeywords` array items
7. **Fix L6** -- Remove unused `globals: true` from vitest configs

### Ongoing

8. **Fix L2** -- Add `afterEach` to `validate.test.ts` for consistency
9. **Fix L5** -- Add explicit return type to `featureGate`
10. **Fix L7** -- Document BCP 47 regex limitations in schema
